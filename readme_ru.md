<h1>SMS-сервер для отправки сообщений с помощью GSM-модема</h1>

<p>Данное приложение позволяет вам отправлять текстовые SMS и flash-сообщения с вашего сервера с подключенным GSM-модемом получателям по номеру телефона. Приложение также записывает отправленные сообщения и результаты, и выводит их в консоль в красивом и удобном виде. Приложение написано на JavaScript с помощью NodeJS и фреймворка Express, а также использует библиотеку serialport-gsm для доступа к подключенным USB-устройствам через NodeJS. Приложение может использоваться как для монолитных приложений, так и в микросервисной архитектуре.</p>

<h2>Пример работы</h2>

<p>Это приложение позволяет легко отправить сообщение с вашего настроенного с этим приложением сервера с подключенным GSM-модемом. Для отправки сообщения вам нужно отправить POST-запрос в формате JSON из вашего приложения на ваш настроенный сервер. Пример запроса:</p>

<pre><code>
{
    "recipient": "+99362000000", // номер получателя (без пробелов, в международном формате)
    "message": "Hello. this SMS from sms_server application" // текст сообщения
}
</code></pre>

<p>Приложение получит и обработает этот запрос, получит доступ к модему и, если не обнаружит проблем с номером и модемом, отправит сообщение на указанный номер.</p>

<h2>Настройка</h2>

<p><b>Примечание</b>: рекомендуется использовать новые поколения модемов, вставить SIM-карту с пополненным балансом и/или приобретенной подпиской на отправку (безлимитных) SMS от вашего оператора связи.</p>

<h3>Предварительные требования</h3>

<ul>
<li>ОС Linux (рекомендуется Ubuntu (20/04 или выше), CentOS 8)</li>
<li>Установленная NodeJS версии не ниже 12.0.0</li>
<li>Подключенный к USB-порту GSM-модем с предоплаченной тарифной SIM-картой</li>
<li>Стандартные системные драйвера Linux для работы с USB-портами</li>
<li>IP-адрес (статический)</li>
</ul>

<h3>Подключение и определение модема</h3>

<p>Перед настройкой вам нужно подключить GSM-модем с SIM-картой к любому доступному USB-порту на сервере. Затем вам нужно узнать адрес подключенного USB-порта командой:</p>

<pre><code>ls /dev/ttyUSB*
</code></pre>

<p>Она покажет адреса подключенных USB-портов (например, <b>/dev/ttyUSB0</b> или что-то подобное, вам нужно запомнить адрес порта, подключенного к USB-модему, он пригодится позже при настройке конфигурации приложения). Вы также можете использовать команду:</p>

<pre><code>dmesg | grep tty
</code></pre>

<p>которая выведет системные сообщения о подключенных устройствах.</p>

<h3>Инициализация и настройка проекта</h3>

<p>Создание и настройка папки для проекта:</p>

<pre><code>mkdir sms_server && cd sms_server
</code></pre>

<p>Загрузка приложения из стабильной ветки репозитория GitHub проекта:</p>

<pre><code>git clone https://github.com/yunusmi/sms_server.git .
</code></pre>

<p>Установка зависимостей проекта:</p>

<pre><code>npm install
</code></pre>

<p>Создание файла .env на основе шаблона .env.example для хранения конфигурации проекта:</p>

<pre><code>cp .env.example .env && nano .env
</code></pre>

<p>В открывшемся файле вам нужно отредактировать следующие значения:</p>

<ul>
<li><b>MODEM_PORT</b> - адрес подключенного USB-порта (команда <b>ls /dev/ttyUSB*</b> показывает список подключенных портов, например, <b>/dev/ttyUSB0</b>, описанный в предыдущих шагах)</li>
<li><b>MODEM_MODE</b> - режим работы модема. Может быть <b>'SMS'</b> или <b>'PDU'</b>. По умолчанию <b>'PDU'</b></li>
<li><b>SMS_TYPE</b> - тип отправляемого SMS. Может быть обычным текстовым сообщением или flash-сообщением. Эта переменная должна иметь логическое значение <b>(true/false)</b>. <b>False - если вы хотите, чтобы система отправляла обычные текстовые SMS-сообщения, true - если она должна отправлять flash-сообщения. По умолчанию false</b></li>
<li><b>APP_PORT</b> - порт для приложения NodeJS <b>(обычно 3000). По умолчанию 3000</b></li>
<li><b>APP_HOST</b> - хост для приложения <b>(обычно localhost). По умолчанию localhost</b></li>
<li><b>TIMEOUT</b> - максимальное время (в миллисекундах) ожидания ответа от модема (из-за некоторых особенностей работы модемов некоторых производителей, ответ от них можно ожидать долго, так как они могут не выдавать ошибку, но при этом не отвечать или отвечать долго). Поэтому вам нужно указать максимальное допустимое время ожидания ответа от модема, по истечении которого программа вернет клиенту ошибку со статусом TimeOut. <b>По умолчанию 30 000 мс. (30 секунд)</b></li>
</ul>

<h2>Запуск и использование</h2>
<p>Перед использованием вам нужно установить диспетчер процессов. Диспетчер процессов позволяет отслеживать и изучать логи и производительность приложения в режиме реального времени, а также перезагружать его в случае ошибок. Рекомендуется использовать pm2.
Для установки pm2 вам нужно ввести команду:</p>

<pre><code>npm install pm2
</code></pre>

<p>затем вы можете запустить приложение, введя команду:</p>

<pre><code>pm2 start ./src/app.js
</code></pre>

<p>Приложение запустится на порту и хосте, указанных в файле .env. </p>
<p>Для мониторинга работы приложения в режиме реального времени вам нужно ввести команду:</p>

<pre><code>pm2 monit
</code></pre>

<p>Для отправки сообщения вам нужно отправить POST-запрос в формате JSON из вашего приложения на адрес <br>
<b>http://YOUR_SMS_CONFIGURED_SERVER_ADDRESS:APP_PORT/send-sms</b>.
Пример запроса:</p>

<pre><code>
{
    "recipient": "+99362000000", // номер получателя (без пробелов, в международном формате)
    "message": "Hello. this SMS from sms_server application" // текст сообщения
}
</code></pre>

<p>Приложение вернет ответ в формате JSON с информацией об отправке сообщения. Пример ответа:</p>

<pre><code>
{
    "success": true,
    "message": "Message successfully has sent to +99362000000"
}
</code></pre>

<p>Приложение также записывает отправленные сообщения и результаты, и выводит их в консоль в красивом и удобном виде. Пример вывода:</p>

<pre><code>
[2021-12-15 16:15:23] [INFO] New request: +99362000000 - Hello. this SMS from sms_server application
[2021-12-15 16:15:23] [INFO] Start sending SMS to +99362000000
[2021-12-15 16:15:24] [INFO] Message successfully has sent to +99362000000
</code></pre>

<p>Для клиентских приложений ответ от сервера, будь то ошибки или успешные отправки, будет содержать короткие ответы. Для более подробного изучения ошибок или отслеживания статусов ответов от сервера предусмотрено запись в текстовый файл и вывод в консоль терминала. Все записи логов хранятся в каталоге <b>src/logs</b>. Каждый день, система создаст записи логов для этого дня и сохранит их в том же каталоге. Имя файла лога начинается с текущей даты и заканчивается на <b>_log.txt</b></p>

<p>В записях логов <b>status</b> - статус отправки сообщения, <b>message</b> - текстовое описание статуса, <b>data</b> - все данные об отправленном сообщении, включая номер получателя, текст сообщения и ссылку на сообщение в модеме.</p>

<h2>Заключение</h2>

<p>Этот проект распространяется под лицензией MIT. Вы можете использовать весь код этого проекта на своих проектах бесплатно. </p>
<p align="center">Если вам нужна моя помощь или консультация, вы можете связаться со мной по электронной почте: <a href="mailto:contact@yunus-mil.ru">contact@yunus-mil.ru</a></p>
